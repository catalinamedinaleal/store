<!doctype html>
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#f6f8ff" />
  <meta name="format-detection" content="telephone=no" />

  <title>Store ¬∑ Manager</title>
  <meta name="description" content="Store interno: cat√°logo, inventario, ventas y movimientos. (Sheets + Apps Script + Firebase Auth)" />

  <!-- Open Graph -->
  <meta property="og:title" content="Store ¬∑ Manager" />
  <meta property="og:description" content="Cat√°logo, inventario, ventas y auditor√≠a interna (Sheets + Apps Script + Firebase Auth)." />
  <meta property="og:type" content="website" />

  <!-- Performance hints -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://apis.google.com" crossorigin />
  <link rel="preconnect" href="https://accounts.google.com" crossorigin />
  <link rel="preconnect" href="https://script.google.com" crossorigin />
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin />
  <link rel="preconnect" href="https://docs.google.com" crossorigin />
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin />
  <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin />

  <!-- CSP
    - Firebase Auth (Google provider) puede cargar scripts desde apis.google.com
    - Chrome DevTools intenta cargar sourcemaps desde gstatic (connect-src)
    - Apps Script usa script.google.com + script.googleusercontent.com
  -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    base-uri 'self';
    object-src 'none';

    form-action 'self';

    script-src
      'self'
      https://www.gstatic.com
      https://apis.google.com
      https://script.google.com
      'unsafe-inline'
      'unsafe-eval';

    style-src 'self' 'unsafe-inline';

    img-src 'self' data: https:;

    connect-src
      'self'
      https://www.gstatic.com
      https://script.google.com
      https://script.googleusercontent.com
      https://www.googleapis.com
      https://identitytoolkit.googleapis.com
      https://securetoken.googleapis.com;

    frame-src
      'self'
      https://accounts.google.com
      https://*.firebaseapp.com
      https://*.web.app;
  " />

  <!-- CSS -->
  <link rel="preload" href="./styles.css" as="style" />
  <link rel="stylesheet" href="./styles.css" />

  <!-- Tiny hardening -->
  <meta name="referrer" content="strict-origin-when-cross-origin" />
</head>

<body data-view="loading">
  <noscript>
    <div style="padding:16px;max-width:900px;margin:16px auto;border:1px solid rgba(11,16,32,.12);border-radius:14px;background:#fff;">
      <strong>JavaScript est√° desactivado.</strong>
      <div style="margin-top:6px;color:rgba(11,16,32,.75);">
        Este panel necesita JavaScript para autenticaci√≥n y conexi√≥n con Sheets/Apps Script.
      </div>
    </div>
  </noscript>

  <!-- Skip link -->
  <a class="skip-link" href="#main">Saltar al contenido</a>

  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="topbar__left">
      <div class="brand" aria-label="Marca Store">
        <div class="brand__dot" aria-hidden="true"></div>
        <div class="brand__text">
          <div class="brand__title">Store</div>
          <div class="brand__sub">Manager interno</div>
        </div>
      </div>
    </div>

    <div class="topbar__right" role="navigation" aria-label="Estado y sesi√≥n">
      <div class="pill" id="netPill" title="Estado de conexi√≥n" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span id="netLabel">Conectando‚Ä¶</span>
      </div>

      <div class="pill" id="userPill" hidden>
        <span class="avatar" id="userAvatar" aria-hidden="true">üë§</span>
        <span class="mono" id="userEmail">‚Äî</span>
        <button class="btn btn--ghost" id="btnLogout" type="button">Salir</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main" class="wrap" role="main">
    <!-- LOADING -->
    <section class="panel" id="viewLoading" data-view="loading" aria-label="Cargando">
      <div class="center">
        <div class="spinner" aria-hidden="true"></div>
        <h1 class="h1">Cargando Store‚Ä¶</h1>
        <p class="muted">Validando sesi√≥n y preparando datos.</p>
      </div>
    </section>

    <!-- AUTH / LOGIN -->
    <section class="panel" id="viewAuth" data-view="auth" hidden aria-label="Inicio de sesi√≥n">
      <div class="auth">
        <div class="card auth__card">
          <h1 class="h1">Iniciar sesi√≥n</h1>
          <p class="muted">Acceso interno. Si no est√°s en la lista, no entras. As√≠ es la vida.</p>

          <form id="loginForm" class="form" autocomplete="on" novalidate>
            <label class="field">
              <span class="label">Correo</span>
              <input
                class="input"
                id="email"
                name="email"
                type="email"
                placeholder="correo@dominio.com"
                required
                autocomplete="email"
                inputmode="email"
              />
            </label>

            <label class="field">
              <span class="label">Contrase√±a</span>
              <input
                class="input"
                id="password"
                name="password"
                type="password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
                autocomplete="current-password"
              />
            </label>

            <div class="row">
              <button class="btn btn--primary" id="btnLogin" type="submit">Entrar</button>
              <button
                class="btn btn--ghost"
                id="btnGoogle"
                type="button"
                title="Requiere Google provider habilitado en Firebase Auth"
              >
                Entrar con Google
              </button>
            </div>

            <div class="hint">
              <span class="kbd">Tip</span>
              <span class="muted">Si usan solo Google, pueden ocultar el login por contrase√±a luego.</span>
            </div>
          </form>

          <div class="divider"></div>

          <div class="tiny muted">
            <div><strong>Estado:</strong> <span id="authStatus">Listo</span></div>
            <div><strong>API:</strong> <span class="mono" id="apiHint">‚Äî</span></div>
          </div>
        </div>

        <div class="card auth__side">
          <h2 class="h2">Qu√© puedes hacer aqu√≠</h2>
          <ul class="list">
            <li>üì¶ Cat√°logo: crear/editar/activar productos</li>
            <li>üìä Inventario: ajustes y alertas por m√≠nimo</li>
            <li>üßæ Ventas: carrito, total en vivo, registro</li>
            <li>üß† Auditor√≠a: movimientos de inventario</li>
          </ul>
          <p class="muted tiny">Todo se guarda en Sheets, con historial real (movimientos). Nada de ‚Äúse me perdi√≥ stock‚Äù üëÄ.</p>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="panel" id="viewApp" data-view="app" hidden aria-label="Aplicaci√≥n">
      <!-- Hero / KPIs -->
      <section class="hero" aria-label="Resumen">
        <div class="hero__left">
          <h1 class="h1">Panel Store</h1>
          <p class="muted">Cat√°logo, inventario y ventas. En COP sin decimales.</p>
        </div>

        <div class="hero__right kpis" aria-label="Indicadores">
          <div class="kpi">
            <div class="kpi__label">Ventas hoy</div>
            <div class="kpi__value mono" id="kpiToday">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">√çtems cat√°logo</div>
            <div class="kpi__value mono" id="kpiProducts">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Stock cr√≠tico</div>
            <div class="kpi__value mono" id="kpiLowStock">‚Äî</div>
          </div>
        </div>
      </section>

      <!-- Nav -->
      <nav class="tabs" aria-label="Secciones">
        <button class="tab is-active" data-tab="catalog" type="button">Cat√°logo</button>
        <button class="tab" data-tab="inventory" type="button">Inventario</button>
        <button class="tab" data-tab="sales" type="button">Ventas</button>
        <button class="tab" data-tab="moves" type="button">Movimientos</button>
        <button class="tab" data-tab="dashboard" type="button">Dashboard</button>

        <div class="tabs__spacer"></div>

        <button class="btn btn--ghost" id="btnOpenSheet" type="button" title="Abrir el Google Sheet">Sheet</button>
        <button class="btn btn--ghost" id="btnRefresh" type="button">Actualizar</button>
      </nav>

      <!-- TAB: Catalog -->
      <section class="card tabview" id="tab-catalog">
        <div class="card__head">
          <div>
            <h2 class="h2">Cat√°logo</h2>
            <p class="muted tiny">Buscar, editar y activar/desactivar productos.</p>
          </div>
          <div class="card__actions">
            <input class="input input--sm" id="qCatalog" type="text"
              placeholder="Buscar (nombre, marca, categor√≠a, sku, stock)‚Ä¶" />
            <button class="btn btn--primary" id="btnNewProduct" type="button">Nuevo producto</button>
          </div>
        </div>

        <div class="tablewrap">
          <table class="table" id="tblCatalog">
            <thead>
              <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Marca</th>
                <th>Categor√≠a</th>
                <th class="num">Precio venta</th>
                <th class="num">Stock</th>
                <th>Estado</th>
                <th class="num">Acciones</th>
              </tr>
            </thead>
            <tbody id="catalogBody">
              <tr><td colspan="8" class="muted">Cargando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- TAB: Inventory -->
      <section class="card tabview" id="tab-inventory" hidden>
        <div class="card__head">
          <div>
            <h2 class="h2">Inventario</h2>
            <p class="muted tiny">Ajustes r√°pidos y alertas de m√≠nimo.</p>
          </div>
          <div class="card__actions">
            <input class="input input--sm" id="qInventory" type="text" placeholder="Buscar por ID producto‚Ä¶" />
            <button class="btn btn--primary" id="btnAdjustStock" type="button">Ajustar stock</button>
          </div>
        </div>

        <div class="tablewrap">
          <table class="table" id="tblInventory">
            <thead>
              <tr>
                <th>Producto ID</th>
                <th class="num">Stock</th>
                <th class="num">M√≠nimo</th>
                <th>Ubicaci√≥n</th>
                <th>Actualizado</th>
              </tr>
            </thead>
            <tbody id="inventoryBody">
              <tr><td colspan="5" class="muted">Cargando‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- TAB: Sales -->
      <section class="card tabview" id="tab-sales" hidden>
        <div class="card__head">
          <div>
            <h2 class="h2">Ventas</h2>
            <p class="muted tiny">Carrito simple, total en vivo, registro en Sheets.</p>
          </div>
          <div class="card__actions">
            <button class="btn btn--primary" id="btnNewSale" type="button">Nueva venta</button>
          </div>
        </div>

        <!-- Pedidos pendientes -->
        <div class="card subcard" id="ordersPane" style="margin-top:14px;">
          <div class="card__head">
            <div>
              <h3 class="h3">Pedidos pendientes</h3>
              <p class="muted tiny">Ventas guardadas como <b>Pendiente</b> (seguimiento + convertir a venta).</p>
            </div>
            <div class="card__actions">
              <button class="btn btn--ghost" id="btnRefreshOrders" type="button">Actualizar</button>
            </div>
          </div>

          <div class="tablewrap">
            <table class="table table--compact">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th class="num">Total</th>
                  <th>Notas</th>
                  <th class="num">Acciones</th>
                </tr>
              </thead>
              <tbody id="ordersBody">
                <tr><td colspan="5" class="muted">Cargando‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
          <div class="tiny muted" id="ordersMeta"></div>
        </div>

        <div class="empty" id="salesEmpty">
          <div class="empty__icon">üßæ</div>
          <div class="empty__title">A√∫n no hay una venta abierta</div>
          <div class="empty__text muted">Crea una nueva venta para agregar productos y guardar.</div>
        </div>

        <div id="salePane" hidden>
          <div class="saleGrid">
            <div class="saleCol card subcard">
              <h3 class="h3">Carrito</h3>
              <div class="row">
                <input class="input input--sm" id="saleSearch" type="text" list="saleProductsList" placeholder="Buscar producto (lista)‚Ä¶" autocomplete="off" />
                <datalist id="saleProductsList"></datalist>
                <button class="btn btn--ghost" id="btnAddToSale" type="button">Agregar</button>
              </div>

              <div class="tablewrap">
                <table class="table table--compact">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th class="num">Cant.</th>
                      <th class="num">Unit.</th>
                      <th class="num">Subtotal</th>
                      <th class="num">‚Äî</th>
                    </tr>
                  </thead>
                  <tbody id="saleItemsBody">
                    <tr><td colspan="5" class="muted">Sin items‚Ä¶</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="saleTotal">
                <div class="muted">Total</div>
                <div class="mono big" id="saleTotal">$0</div>
              </div>
            </div>

            <div class="saleCol card subcard">
              <h3 class="h3">Guardar venta</h3>

              <label class="field">
                <span class="label">Cliente <span class="muted tiny">(opcional)</span></span>
                <input class="input" id="saleCustomer" type="text" placeholder="ID o nombre corto" />
              </label>

              <label class="field">
                <span class="label">M√©todo de pago</span>
                <select class="input" id="salePay">
                  <option value="cash">Efectivo</option>
                  <option value="transfer">Transferencia</option>
                  <option value="card">Tarjeta</option>
                  <option value="mixed">Mixto</option>
                </select>
              </label>

              <label class="field">
                <span class="label">Estado</span>
                <select class="input" id="saleStatus">
                  <option value="paid">Pagado</option>
                  <option value="pending">Pendiente</option>
                  <option value="cancelled">Cancelado</option>
                </select>
              </label>

              <label class="field">
                <span class="label">Notas</span>
                <textarea class="input" id="saleNotes" rows="3" placeholder="Observaciones‚Ä¶"></textarea>
              </label>

              <div class="row">
                <button class="btn btn--primary" id="btnSaveSale" type="button">Guardar venta</button>
                <button class="btn btn--ghost" id="btnCancelSale" type="button">Cerrar</button>
              </div>

              <p class="tiny muted">Guardar descuenta inventario (si no est√° cancelada) y deja movimiento registrado.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: Moves -->
      <section class="card tabview" id="tab-moves" hidden>
        <div class="card__head">
          <div>
            <h2 class="h2">Movimientos</h2>
            <p class="muted tiny">Auditor√≠a: entradas, salidas, ajustes, ventas.</p>
          </div>
          <div class="card__actions">
            <input class="input input--sm" id="qMoves" type="text" placeholder="Filtrar por producto o ref‚Ä¶" />
          </div>
        </div>

        <div class="empty">
          <div class="empty__icon">üß†</div>
          <div class="empty__title">Esta vista la conectamos con endpoint cuando sigamos</div>
          <div class="empty__text muted">El backend ya guarda movimientos. En el front toca listar y filtrar.</div>
        </div>
      </section>

      <!-- TAB: Dashboard -->
      <section class="card tabview" id="tab-dashboard" hidden>
        <div class="card__head">
          <div>
            <h2 class="h2">Dashboard</h2>
            <p class="muted tiny">Resumen r√°pido: ventas hoy y stock cr√≠tico.</p>
          </div>
        </div>

        <div class="dash">
          <div class="card subcard">
            <div class="kpi kpi--big">
              <div class="kpi__label">Ventas hoy</div>
              <div class="kpi__value mono" id="dashToday">‚Äî</div>
            </div>
            <div class="muted tiny">Basado en ventas con status pagado.</div>
          </div>

          <div class="card subcard">
            <h3 class="h3">Stock cr√≠tico</h3>
            <div class="tablewrap">
              <table class="table table--compact">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="num">Stock</th>
                    <th class="num">M√≠nimo</th>
                  </tr>
                </thead>
                <tbody id="lowStockBody">
                  <tr><td colspan="3" class="muted">‚Äî</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Toast -->
      <div class="toast" id="toast" role="status" aria-live="polite" hidden></div>
    </section>
  </main>

  <!-- Modal: Product -->
  <dialog class="modal" id="modalProduct">
    <form method="dialog" class="modal__card" id="productForm">
      <div class="modal__head">
        <div>
          <h3 class="h3" id="productTitle">Producto</h3>
          <p class="muted tiny">Crear o editar producto.</p>
        </div>
        <button class="btn btn--ghost" value="cancel" type="submit">Cerrar</button>
      </div>

      <div class="grid2">
        <label class="field">
          <span class="label">ID</span>
          <input class="input" id="p_id" type="text" placeholder="(auto)" />
        </label>

        <label class="field">
          <span class="label">Activo</span>
          <select class="input" id="p_active">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </label>

        <label class="field">
          <span class="label">Nombre</span>
          <input class="input" id="p_name" type="text" required />
        </label>

        <label class="field">
          <span class="label">Marca</span>
          <input class="input" id="p_brand" type="text" />
        </label>

        <label class="field">
          <span class="label">Categor√≠a</span>
          <input class="input" id="p_category" type="text" placeholder="instrumento / accesorio / arte‚Ä¶" />
        </label>

        <label class="field">
          <span class="label">SKU <span class="muted tiny">(c√≥digo interno opcional)</span></span>
          <input class="input" id="p_sku" type="text" placeholder="Ej: GTR-BLCA-01" />
        </label>

        <label class="field">
          <span class="label">Costo (COP) <span class="muted tiny">¬∑ interno</span></span>
          <input class="input" id="p_cost" type="number" inputmode="numeric" step="1" min="0" />
          <span class="muted tiny" style="margin-top:6px;display:block;">Lo que les vale a ustedes (proveedor + costos si aplican).</span>
        </label>

        <label class="field">
          <span class="label">Ganancia (%) <span class="muted tiny">¬∑ sobre costo</span></span>
          <input class="input" id="p_margin" type="number" inputmode="decimal" step="0.1" min="0" placeholder="30" />
          <span class="muted tiny" style="margin-top:6px;display:block;">Porcentaje de ganancia sobre el costo (markup).</span>
        </label>

        <label class="field">
          <span class="label">Precio de venta (COP)</span>
          <input class="input" id="p_price" type="number" inputmode="numeric" step="1" min="0" />
          <span class="muted tiny" style="margin-top:6px;display:block;">Lo que paga el cliente (precio final).</span>
        </label>

        <label class="field" style="grid-column: 1 / -1;">
          <span class="label">Descripci√≥n</span>
          <textarea class="input" id="p_desc" rows="3"></textarea>
        </label>

        <label class="field" style="grid-column: 1 / -1;">
          <span class="label">Imagen URL</span>
          <input class="input" id="p_image" type="url" placeholder="https://..." />
        </label>
      </div>

      <div class="modal__foot">
        <button class="btn btn--primary" id="btnSaveProduct" type="button">Guardar</button>
        <button class="btn btn--ghost" value="cancel" type="submit">Cancelar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Stock adjust -->
  <dialog class="modal" id="modalStock">
    <form method="dialog" class="modal__card" id="stockForm">
      <div class="modal__head">
        <div>
          <h3 class="h3">Ajuste de inventario</h3>
          <p class="muted tiny">Esto crea movimiento y actualiza stock.</p>
        </div>
        <button class="btn btn--ghost" value="cancel" type="submit">Cerrar</button>
      </div>

      <div class="grid2">
        <label class="field" style="grid-column: 1 / -1;">
          <span class="label">Producto ID</span>
          <input class="input" id="s_product_id" type="text" placeholder="P‚Ä¶" required />
        </label>

        <label class="field">
          <span class="label">Tipo</span>
          <select class="input" id="s_type">
            <option value="adjust">Ajuste</option>
            <option value="purchase">Compra</option>
            <option value="loss">P√©rdida</option>
            <option value="return">Devoluci√≥n</option>
          </select>
        </label>

        <label class="field">
          <span class="label">Cantidad (+ / -)</span>
          <input class="input" id="s_qty" type="number" step="1" inputmode="numeric" required />
        </label>

        <label class="field" style="grid-column: 1 / -1;">
          <span class="label">Referencia <span class="muted tiny">(opcional)</span></span>
          <input class="input" id="s_ref" type="text" placeholder="FAC-123 / nota..." />
        </label>

        <label class="field" style="grid-column: 1 / -1;">
          <span class="label">Nota</span>
          <textarea class="input" id="s_note" rows="2" placeholder="Motivo del ajuste‚Ä¶"></textarea>
        </label>
      </div>

      <div class="modal__foot">
        <button class="btn btn--primary" id="btnSaveStock" type="button">Aplicar</button>
        <button class="btn btn--ghost" value="cancel" type="submit">Cancelar</button>
      </div>
    </form>
  </dialog>

  <!-- CONFIG -->
  <script>
    const API_BASE_RAW = "https://script.google.com/macros/s/AKfycbzov-q6zscegWhB-CDfiaZ3q3KAXaYr4f8HUCDtdpRXfsDI7zwJxWBUYYDz6t_6UPLRMQ/exec";
    const API_BASE = String(API_BASE_RAW || "").trim().replace(/\/+$/, "");

    window.STORE_CFG = Object.freeze({
      API_BASE,
      SHEET_URL: "https://docs.google.com/spreadsheets/d/1vBSv51xdLwdidNBpBpzKfhha7kBz0D1S4cm8qJJckoQ/edit",
      CURRENCY: "COP",
      LOCALE: "es-CO",
      BUILD: "2026-02-10",
    });
  </script>

  <!-- Firebase + Boot -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const firebaseConfig = Object.freeze({
      apiKey: "AIzaSyBm8RWGMxw9uz4iMmr0Chf3uiLzMY7TzOE",
      authDomain: "store2026-77c54.firebaseapp.com",
      projectId: "store2026-77c54",
      storageBucket: "store2026-77c54.firebasestorage.app",
      messagingSenderId: "190041780965",
      appId: "1:190041780965:web:a594ed82ca71f826f3da0c"
    });

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);

    const googleProvider = new GoogleAuthProvider();
    // googleProvider.setCustomParameters({ prompt: "select_account" });

    window.__FB__ = Object.freeze({
      auth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      googleProvider,
      signOut
    });

    try {
      const mod = await import("./app.js");
      if (!mod || typeof mod.boot !== "function") {
        console.error("app.js carg√≥ pero no expone boot()");
        alert("Error: app.js no expone boot(). Revisa export en app.js.");
      } else {
        mod.boot();
      }
    } catch (e) {
      console.error("Error cargando app.js:", e);
      alert("Error cargando la app. Revisa consola (F12).");
    }
  </script>
</body>
</html>
